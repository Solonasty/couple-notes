<section class="notes">
  <!-- LIST -->
  <div class="list" [class.dimmed]="isDetailOpen()">
    <header class="header">
      <div class="title">
        <h1 class="h1">Заметки</h1>
        <span class="count">( {{ notesCount() }} )</span>
      </div>

      @if (!inPair()) {
        <div class="hint">Вступите в пару, чтобы добавлять и видеть заметки</div>
      } @else {
        <ui-button
          (click)="openNew()"
          variant="outline"
          type="button"
          [loading]="loading()">
          Добавить
        </ui-button>
      }
    </header>

    @if (!inPair()) {
      <p class="empty">Вы сможете добавлять и видеть заметки, когда вступите в пару.</p>
    } @else if (notes().length === 0) {
      <p class="empty">Пока нет заметок. Нажмите “+”.</p>
    } @else {
      <div class="grid" role="list">
        @for (n of notes(); track n.id; let i = $index) {
          <article
            class="card note"
            [ngClass]="noteColorClass(n, i)"
            role="button"
            tabindex="0"
            (click)="openExisting(n.id)">
            <div class="meta">{{ n.createdAt?.toDate?.() | date:'dd.MM.yyyy, HH:mm' }}</div>
            <div class="text">{{ n.text }}</div>
          </article>
        }
      </div>
    }
  </div>

  <!-- DETAIL OVERLAY -->
  @if (isDetailOpen()) {
    <div class="detail" [class.closing]="closing()">
      <div class="detail-bar">
        <ui-button
          (click)="back()"
          variant="ghost"
          type="button"
          [disabled]="loading()">
          <ui-icon name="arrow_back"></ui-icon>
          <span>Назад</span>
        </ui-button>

        @if (isEditMode()) {
          <ui-button
            class="ui-btn--h48"
            (click)="deleteCurrent()"
            variant="ghost"
            type="button"
            [disabled]="loading()"
            [iconOnly]="true"
            aria-label="Удалить">
            <ui-icon class="danger-ink" name="delete" size="lg"></ui-icon>
          </ui-button>

        } @else {
          <div class="right-placeholder"></div>
        }
      </div>


      @if (isEditMode() && openedNote(); as note) {
        <h1 class="detail-meta">Редактирование</h1>

        <div class="detail-meta-row">
          <span class="meta-chip">
            {{ note.createdAt?.toDate?.() | date:'dd.MM.yyyy, HH:mm' }}
          </span>

          <span class="meta-chip">
            <span class="dot" [class.saving]="saving()" [class.saved]="!saving()"></span>
            {{ saving() ? 'Сохраняю…' : 'Сохранено' }}
          </span>
        </div>
      } @else {
        <h1 class="detail-meta">Новая заметка</h1>
      }


      <form class="detail-body" [formGroup]="editorForm">
        <div class="editor-card">
          <textarea
            class="detail-textarea"
            rows="10"
            formControlName="text"
            placeholder="Текст заметки…">
          </textarea>
        </div>
      </form>

    </div>
  }
</section>
