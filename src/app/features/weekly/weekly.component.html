<div class="page">
  <div class="page-header">
    <header class="page-header__row">
      <div class="page-header__title">
        <h1 class="page-header__h1">Сводка недели</h1>
      </div>
    </header>
  </div>

  <div class="card">
    <!-- Статус и период -->
    <div class="section">
      <h2 class="section-title">Статус отчёта</h2>

      <p class="status">{{ statusText() }}</p>

      @if (periodText()) {
        <div class="meta-line">
          <span class="label-inline">Период отчёта:</span>
          <span>{{ periodText() }}</span>
        </div>
      }

      <div class="hint vpn-hint">
        Важно: для генерации отчёта включите VPN (запрос к LLM работает только через VPN).
      </div>
    </div>

    <!-- Действия -->
    <div class="section">
      <h2 class="section-title">Действия</h2>

      <div class="actions-grid">
        <ui-button
          class="ui-btn--h56 ui-btn--no-dim"
          [full]="true"
          variant="primary"
          type="button"
          [disabled]="loading() || !canGenerate()"
          [loading]="loading()"
          (click)="generate()">
          СФОРМИРОВАТЬ ОТЧЁТ
        </ui-button>

        <ui-button
          class="ui-btn--h56 ui-btn--no-dim"
          [full]="true"
          variant="outline"
          type="button"
          [disabled]="loading() || !canGet()"
          (click)="getReport()">
          ПОЛУЧИТЬ ОТЧЁТ
        </ui-button>
      </div>

      @if (loading()) {
        <div class="hint">Генерация отчёта…</div>
      }
    </div>

    <!-- Ошибки -->
    @if (uiError()) {
      <div class="form-error" role="alert">{{ uiError() }}</div>
    }

    @if (report()?.status === 'error') {
      <div class="form-error" role="alert">{{ report()?.error }}</div>
    }

    <!-- Текст отчёта -->
    @if (summary()) {
      <div class="section">
        <h2 class="section-title">Текст отчёта</h2>
        <pre class="report-pre">{{ summary() }}</pre>
      </div>
    }

    <!-- Метаданные отчёта -->
    @if (report()?.status === 'ready') {
      <div class="section">
        <h2 class="section-title">Информация</h2>

        <div class="meta-grid">
          <div class="meta-item">
            <div class="label">Сформировал</div>
            <div class="value">{{ report()?.createdBy }}</div>
          </div>

          <div class="meta-item">
            <div class="label">Заметок в отчёте</div>
            <div class="value">{{ report()?.notesCount }}</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">Заметки для отчёта</h2>
        <p class="muted debug-caption">Debug: заметки, использованные для генерации</p>

        @if (!hasSourceNotes()) {
          <p class="muted">Список пуст.</p>
        } @else {
          <div class="notes-list">
            @for (n of sourceNotes(); track n.id) {
              <div class="note-card">
                <div class="note-meta">
                  <span><b>ownerUid:</b> {{ n.ownerUid }}</span>
                  <span>·</span>
                  <span><b>noteId:</b> {{ n.id }}</span>
                </div>

                <div class="note-text">
                  {{ n.text }}
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>